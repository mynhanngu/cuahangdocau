<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒêang t·∫£i d·ªØ li·ªáu...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#e87913', primaryHover: '#cf680a', dark: '#1a1a1a' }, fontFamily: { sans: ['Inter', 'sans-serif'] }, boxShadow: { 'modern': '0 10px 25px -5px rgba(0, 0, 0, 0.1)' } } } }
    </script>
    <style>
        :root { --header-bg: #000000; --header-text: #ffffff; --main-color: #e87913; --brand-color: #e87913; --slogan-color: #6b7280; --gradient-colors: #cc0000, #e87913, #cc0000; }
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #f8f9fa; color: var(--dark); overscroll-behavior-y: none; }
        .dynamic-header { background-color: var(--header-bg) !important; color: var(--header-text) !important; }
        .logo-crop-container { 
            position: absolute; left: 50%; top: 0; transform: translateX(-50%); 
            height: 100%; width: 60vw; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; z-index: 40; pointer-events: none; 
        }
        .custom-logo { 
            height: 140%; 
            width: auto; 
            object-fit: contain; 
            display: none; 
            pointer-events: auto; cursor: pointer; 
            transition: transform 0.3s ease; 
        }
        @keyframes gradientLeftToRight { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
        .cart-badge { position: absolute; top: -2px; right: 4px; background: transparent !important; border: none !important; font-size: 13px; font-weight: 900; color: #cc5500; opacity: 0; transform: scale(0); transition: all 0.2s ease; }
        .cart-badge.show { opacity: 1; transform: scale(1); }
        .marquee-wrap { background: #111; color: #fff; height: 36px; overflow: hidden; display: flex; align-items: center; position: relative; }
        .marquee-track { display: flex; white-space: nowrap; animation: marquee-scroll 20s linear infinite; }
        .marquee-item { display: inline-flex; align-items: center; padding-right: 3rem; font-size: 13px; font-weight: 500; }
        .marquee-item i { margin-right: 8px; color: var(--main-color); }
        @keyframes marquee-scroll { 0% { transform: translate3d(0,0,0); } 100% { transform: translate3d(-50%,0,0); } }
        .banner-container { position: relative; width: 100%; aspect-ratio: 851 / 315; background-color: #000; overflow: hidden; }
        .banner-slider-wrapper { position: absolute; inset: 0; display: flex; transition: transform 0.5s ease-in-out; }
        .banner-slide { width: 100%; height: 100%; flex-shrink: 0; }
        .banner-slide img { width: 100%; height: 100%; object-fit: cover; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
        .modal-wrapper { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s; background-color: rgba(0,0,0,0.6); }
        .modal-wrapper.open { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { transform: scale(0.95) translateY(20px); transition: all 0.3s ease-out; box-shadow: var(--modern-shadow); }
        .modal-wrapper.open .modal-content { transform: scale(1) translateY(0); }
        @media (max-width: 768px) { .modal-wrapper { align-items: flex-end; } .modal-wrapper .modal-content { transform: translateY(100%); border-radius: 0; } .modal-wrapper.open .modal-content { transform: translateY(0); } .pm-mobile-full { position: absolute !important; inset: 0 !important; width: 100%; height: 100% !important; max-height: 100% !important; display: flex; flex-direction: column; overflow: hidden; background: white; } }
        #mobile-menu { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); z-index: 60; }
        #mobile-menu.open { transform: translateX(0); }
        .card-gradient-border { position: relative; background: linear-gradient(to right, var(--gradient-colors)); background-size: 200% auto; animation: gradientLeftToRight 3s linear infinite; padding: 2px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; display: flex; flex-direction: column; height: 100%; }
        .card-gradient-border:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.15); }
        .card-inner { background: #ffffff; border-radius: 12px; display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .product-image-wrapper { position: relative; width: 100%; padding-bottom: 100%; overflow: hidden; background: #fff; border-bottom: 1px solid #f3f4f6;}
        .product-image { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; transition: transform 0.5s; padding: 8px; }
        .card-gradient-border:hover .product-image { transform: scale(1.05); }
        .product-badge { position: absolute; top: 8px; left: 8px; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .product-title { font-size: 13px; font-weight: 600; color: #1a1a1a; line-height: 1.4; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 38px; }
        .product-price-current { background: linear-gradient(to right, var(--gradient-colors)); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradientLeftToRight 2s linear infinite; }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        #app-loading { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .loading-bar-wrapper { width: 200px; height: 6px; background-color: #f3f4f6; border-radius: 10px; overflow: hidden; position: relative; }
        .loading-bar { width: 40%; height: 100%; background-color: var(--main-color); border-radius: 10px; position: absolute; left: -40%; animation: load-progress 1.5s infinite ease-in-out; }
        @keyframes load-progress { 0% { left: -40%; width: 40%; } 50% { left: 20%; width: 80%; } 100% { left: 100%; width: 40%; } }
        .loading-text { margin-top: 15px; font-size: 10px; font-weight: 700; color: var(--main-color); text-transform: uppercase; letter-spacing: 1px; animation: pulse-text 1.5s infinite; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; } .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; } .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        #pm-slider-track { display: flex; height: 100%; transition: transform 0.3s; touch-action: pan-y; }
        .input-error { box-shadow: 0 0 0 2px #ef4444 !important; background-color: #fef2f2 !important; transition: all 0.3s ease; }
        #variant-sheet { z-index: 150 !important; align-items: flex-end; }
        @media (min-width: 768px) { #variant-sheet { align-items: center !important; } }
        /* Box Variant: ƒêt bo cong b√™n tr√™n, mt bo cong ƒë·ªÅu 4 g√≥c */
        .sheet-content { background: #fff; width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; max-height: 90dvh; position: relative;}
        @media (min-width: 768px) { .sheet-content { border-radius: 24px !important; transform: scale(0.95) translateY(20px) !important; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2); } }
        #variant-sheet.open .sheet-content { transform: translateY(0) scale(1) !important; }
        .toast-1-line { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; padding: 10px 16px; font-size: 13px; font-weight: 500; white-space: nowrap; z-index: 200; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; transition: opacity 0.3s; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50 text-dark flex flex-col min-h-screen font-sans">
    <div id="app-loading">
        <div class="loading-bar-wrapper"><div class="loading-bar"></div></div>
        <div class="loading-text mt-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest">ƒêANG T·∫¢I D·ªÆ LI·ªÜU...</div>
    </div>
    <header class="dynamic-header sticky top-0 z-40 shadow-lg h-16 px-4 transition-colors duration-300 relative shrink-0">
        <div class="w-full h-full flex items-center justify-between relative z-10">
            <button class="p-2 w-12 h-12 flex items-center justify-center text-2xl focus:outline-none hover:opacity-80 text-white transition bg-transparent" onclick="openMenu()"><i class="fa-solid fa-bars"></i></button>
            <div class="relative p-2 w-12 h-12 flex items-center justify-center cursor-pointer hover:opacity-80 transition" onclick="openModal('cart-modal'); renderCartItems();">
                <i class="fa-solid fa-cart-shopping text-xl text-white"></i>
                <div id="cart-count" class="cart-badge"><span>0</span></div>
            </div>
        </div>
        <div class="logo-crop-container">
            <div id="default-logo-wrap" class="flex items-center pointer-events-auto cursor-pointer" onclick="switchView('shop', true); renderProducts('all'); closeMenu();">
                <i class="fa-solid fa-fish text-3xl mr-3 text-white"></i>
                <span id="header-shop-name" class="font-black text-2xl tracking-wide uppercase text-white tracking-tighter">SHOP</span>
            </div>
            <img id="img-logo-display" src="" class="custom-logo" alt="Shop Logo" onclick="switchView('shop', true); renderProducts('all'); closeMenu();" onerror="this.style.display='none'; document.getElementById('default-logo-wrap').style.display='flex';">
        </div>
    </header>
    <div id="overlay" class="fixed inset-0 bg-black/50 z-50 transition-opacity duration-300 opacity-0 pointer-events-none" onclick="closeMenu()"></div>
    <nav id="mobile-menu" class="fixed top-0 left-0 h-full w-[85%] max-w-sm shadow-2xl flex flex-col font-sans bg-white rounded-r-3xl overflow-hidden">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10 shrink-0">
            <span class="font-extrabold text-dark text-xl tracking-tight">MENU</span>
            <button onclick="closeMenu()" class="w-12 h-12 flex items-center justify-end text-red-600 hover:text-red-700 bg-transparent border-none outline-none cursor-pointer"><i class="fa-solid fa-xmark text-3xl"></i></button>
        </div>
        <div class="p-5 space-y-6 flex-1 overflow-y-auto custom-scrollbar">
             <div class="relative">
                <input type="text" id="menu-search-input" oninput="handleSearch(this.value)" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="w-full bg-gray-100 border-0 rounded-xl px-4 py-3 pl-11 outline-none font-medium">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-gray-400"></i>
            </div>
             <div class="space-y-2">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Danh m·ª•c</h3>
                <a href="#" onclick="event.preventDefault(); filterByCategory('all');" class="flex items-center p-3 rounded-xl font-medium text-gray-700 hover:bg-orange-50 hover:text-primary transition group">
                    <span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-3 group-hover:bg-orange-200 transition"><i class="fa-solid fa-house text-gray-500 group-hover:text-primary"></i></span> Trang ch·ªß
                </a>
                <div id="menu-categories" class="space-y-2"></div>
            </div>
             <div class="space-y-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Ti·ªán √≠ch</h3>
                 <button onclick="switchView('tracking'); closeMenu();" class="w-full flex items-center p-3 rounded-xl font-bold text-primary bg-orange-50 hover:bg-orange-100 transition">
                    <span class="w-8 h-8 rounded-lg bg-white/50 flex items-center justify-center mr-3"><i class="fa-solid fa-truck-fast"></i></span> Tra c·ª©u ƒë∆°n h√†ng
                </button>
                 <button onclick="switchView('blog'); closeMenu();" class="w-full flex items-center p-3 rounded-xl font-bold text-primary bg-orange-50 hover:bg-orange-100 transition">
                    <span class="w-8 h-8 rounded-lg bg-white/50 flex items-center justify-center mr-3"><i class="fa-solid fa-book-open"></i></span> G√≥c Kinh Nghi·ªám
                </button>
                 <div class="relative rounded-xl overflow-hidden border border-gray-100">
                    <button onclick="toggleCSKHMenu()" class="w-full flex items-center justify-between p-3 bg-white hover:bg-gray-50 transition font-medium">
                        <div class="flex items-center"><span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-3"><i class="fa-solid fa-headset text-gray-500"></i></span> H·ªó tr·ª£ kh√°ch h√†ng</div>
                        <i class="fa-solid fa-chevron-down text-xs text-gray-400" id="cskh-arrow"></i>
                    </button>
                    <div id="cskh-menu" class="hidden bg-gray-50 border-t border-gray-100">
                         <a id="btn-hotline" href="#" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:text-primary border-b border-gray-100"><i class="fa-solid fa-phone text-green-500"></i> <span id="txt-hotline">...</span></a>
                        <a id="btn-zalo" href="#" target="_blank" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:text-primary border-b border-gray-100"><i class="fa-solid fa-comment-dots text-blue-500"></i> <span>Zalo Shop</span></a>
                        <a id="btn-group" href="#" target="_blank" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-600 hover:text-primary"><i class="fa-solid fa-users text-purple-500"></i> <span>C·ªông ƒë·ªìng</span></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 mt-auto border-t border-gray-100 shrink-0 bg-gray-50 text-center">
            <span id="menu-copy-text" class="text-[11px] font-bold uppercase tracking-widest transition-colors" style="color: var(--brand-color);"></span>
        </div>
    </nav>

    <div class="flex-grow w-full relative z-0">
        <div id="view-shop">
            <div id="main-banner" class="banner-container group">
                <div class="banner-slider-wrapper" id="banner-slider"></div>
                <button onclick="prevBanner()" class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-black/20 hover:bg-black/40 text-white rounded-full hidden md:flex items-center justify-center transition z-20 opacity-0 group-hover:opacity-100 bg-transparent border-none"><i class="fa-solid fa-chevron-left"></i></button>
                <button onclick="nextBanner()" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-black/20 hover:bg-black/40 text-white rounded-full hidden md:flex items-center justify-center transition z-20 opacity-0 group-hover:opacity-100 bg-transparent border-none"><i class="fa-solid fa-chevron-right"></i></button>
                <div id="banner-dots" class="absolute bottom-3 left-0 w-full flex justify-center gap-2 z-20"></div>
            </div>
            <div id="marquee-section" class="marquee-wrap hidden">
                <div class="marquee-track" id="marquee-track"></div>
            </div>
            <main class="container mx-auto px-2 md:px-6 py-6 md:py-10">
                <div class="mb-6 md:mb-8 px-2" id="filter-section" style="display: none;">
                    <h2 class="text-2xl md:text-3xl font-extrabold text-dark relative inline-block" id="category-title">Trang ch·ªß
                        <span class="absolute bottom-1 left-0 w-full h-2 md:h-3 bg-primary/20 -z-10 skew-x-12 rounded-sm"></span>
                    </h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-4 animate-fade-up px-1" id="products-grid"></div>
                <div id="pagination-container" class="mt-12 w-full flex justify-center items-center"></div>
            </main>
        </div>

        <div id="view-tracking" class="hidden container mx-auto px-4 py-8 md:py-12">
             <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-modern p-4 md:p-8 border border-gray-100">
                <div class="text-center mb-6">
                    <div class="inline-flex p-3 md:p-4 rounded-2xl bg-orange-100 text-primary mb-3 md:mb-5"><i class="fa-solid fa-truck-fast text-3xl md:text-5xl"></i></div>
                    <h2 class="text-xl md:text-3xl font-extrabold text-dark mb-1 md:mb-2">Tra c·ª©u ƒë∆°n h√†ng</h2>
                    <p class="text-gray-500 text-xs md:text-sm">Nh·∫≠p ƒë√∫ng 10 s·ªë ƒëi·ªán tho·∫°i b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0 ƒë·ªÉ ki·ªÉm tra.</p>
                </div>
                <div class="space-y-3 md:space-y-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fa-solid fa-phone text-gray-400"></i></div>
                        <input type="tel" id="track-phone-input" oninput="removeError(this)" onkeypress="if(event.key === 'Enter') { event.preventDefault(); performTracking(); }" class="w-full pl-11 md:pl-12 border-0 ring-1 ring-gray-200 rounded-xl px-3 py-3 md:py-4 outline-none font-bold text-base md:text-lg text-dark focus:ring-2 focus:ring-primary transition text-center" placeholder="V√≠ d·ª•: 0912345678...">
                    </div>
                    <button onclick="performTracking()" class="w-full bg-primary hover:bg-primaryHover text-white font-bold py-3 md:py-4 rounded-xl shadow-md transition transform hover:-translate-y-1 text-base md:text-lg"><i class="fa-solid fa-magnifying-glass mr-2"></i>T√åM KI·∫æM</button>
                    <div id="tracking-result-area" class="hidden mt-6 border-t border-gray-100 pt-6"><div id="tracking-list" class="space-y-4"></div></div>
                </div>
                <div class="mt-6 md:mt-8 text-center"><button onclick="switchView('shop')" class="text-gray-500 text-sm font-bold hover:text-primary transition bg-transparent"><i class="fa-solid fa-arrow-left-long mr-2"></i> Quay l·∫°i mua s·∫Øm</button></div>
            </div>
        </div>

        <div id="view-blog" class="hidden container mx-auto px-4 py-12">
             <div class="text-center mb-12">
                <h2 class="text-4xl font-black text-dark uppercase tracking-tight">G√≥c Kinh Nghi·ªám</h2>
                <div class="w-24 h-1.5 bg-primary mx-auto mt-5 rounded-full"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 animate-fade-up" id="blog-grid"></div>
            <div id="blog-pagination-container" class="mt-12 w-full flex justify-center items-center"></div>
            <div class="mt-12 text-center"><button onclick="switchView('shop')" class="text-gray-500 font-bold hover:text-primary transition bg-transparent"><i class="fa-solid fa-arrow-left-long mr-2"></i> Quay l·∫°i mua s·∫Øm</button></div>
        </div>
    </div>

    <footer class="bg-white py-3 flex flex-col items-center justify-center border-t border-gray-100 relative z-10 shrink-0 shadow-[0_-2px_10px_rgba(0,0,0,0.02)]">
        <h3 id="footer-shop-name" class="text-sm font-black uppercase transition-colors" style="color: var(--brand-color);"></h3>
        <p id="footer-slogan" class="text-[11px] font-medium text-center px-4 mt-0.5" style="color: var(--slogan-color);"></p>
    </footer>

    <div id="product-modal" class="modal-wrapper">
        <div class="absolute inset-0" onclick="closeTopModal()"></div>
        <div class="modal-content bg-white pm-mobile-full md:max-w-5xl md:h-[80vh] md:rounded-3xl md:overflow-hidden relative z-10 md:flex md:flex-row shadow-2xl">
            <button onclick="closeTopModal()" class="absolute top-0 right-0 md:top-0 md:right-0 z-[60] w-12 h-12 flex items-center justify-center text-red-600 hover:text-red-700 bg-transparent border-none outline-none drop-shadow-md cursor-pointer"><i class="fa-solid fa-xmark text-3xl"></i></button>
            <div class="w-full h-[350px] md:h-full md:w-1/2 flex-shrink-0 flex flex-col relative bg-white border-b md:border-b-0 md:border-r border-gray-100 z-10">
                <div class="relative flex-1 w-full h-full overflow-hidden group">
                    <div id="pm-slider-track" class="flex h-full w-full transition-transform duration-300"></div>
                    <button onclick="prevPmSlide()" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/20 hover:bg-black/50 text-white rounded-full hidden md:flex items-center justify-center transition z-20 opacity-0 group-hover:opacity-100 shadow-md border-none"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                    <button onclick="nextPmSlide()" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/20 hover:bg-black/50 text-white rounded-full hidden md:flex items-center justify-center transition z-20 opacity-0 group-hover:opacity-100 shadow-md border-none"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                    <div id="pm-dots" class="absolute bottom-4 left-0 w-full flex md:hidden justify-center gap-2 z-20"></div>
                </div>
                <div id="pm-thumbnails" class="hidden md:flex gap-3 p-4 pt-2 overflow-x-auto custom-scrollbar shrink-0 justify-center bg-white border-t border-gray-50"></div>
            </div>
            <div class="w-full flex-1 flex flex-col bg-white relative z-20 md:w-1/2 md:h-full overflow-hidden">
                <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar relative"> 
                    <div class="flex items-center justify-between w-full mb-3 mt-6 md:mt-0">
                        <span id="pm-badge" class="text-white text-[10px] md:text-xs font-bold px-2 py-0.5 md:py-1 rounded uppercase hidden shadow-sm"></span>
                        <span class="text-gray-500 text-[11px] md:text-sm font-medium"><i class="fa-solid fa-fire-flame-simple text-orange-400 mr-1"></i> ƒê√£ b√°n: <span id="pm-sold" class="text-dark font-bold text-xs md:text-sm">0</span></span>
                    </div>
                    <h2 id="pm-title" class="text-xl md:text-2xl font-extrabold text-dark leading-snug mb-2 text-left"></h2>
                    <div id="pm-ghichu" class="text-red-600 text-sm font-bold mb-4 hidden uppercase text-left"></div>
                    <div class="mb-4 pb-4 border-b border-gray-100 overflow-hidden w-full">
                        <div id="pm-price" class="text-2xl md:text-3xl product-price-current whitespace-nowrap overflow-hidden text-ellipsis tracking-tighter">0‚Ç´</div>
                    </div>
                    <h3 class="font-bold text-dark text-base md:text-lg mb-2 flex items-center gap-2 pt-2"><i class="fa-solid fa-circle-info text-primary"></i> Chi ti·∫øt s·∫£n ph·∫©m</h3>
                    <div id="pm-desc" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line text-justify pb-6"></div>
                </div>
                <div class="shrink-0 p-3 pb-6 md:pb-4 border-t border-gray-100 bg-white grid grid-cols-2 gap-3 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] relative z-[9999]">
                    <button onclick="triggerVariantSheet('cart')" class="flex items-center justify-center gap-1.5 bg-orange-50 hover:bg-orange-100 text-primary border border-orange-200 font-bold py-2.5 rounded-lg transition text-sm cursor-pointer"><i class="fa-solid fa-cart-plus text-base"></i><span>Th√™m v√†o gi·ªè</span></button>
                    <button onclick="triggerVariantSheet('buy')" class="flex items-center justify-center gap-1.5 bg-primary hover:bg-primaryHover text-white font-bold py-2.5 rounded-lg shadow-md transition transform hover:-translate-y-0.5 text-sm cursor-pointer"><i class="fa-solid fa-bag-shopping text-base"></i><span>Mua ngay</span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="variant-sheet" class="modal-wrapper">
        <div class="absolute inset-0" onclick="closeTopModal()"></div>
        <div class="sheet-content">
            <div class="p-4 border-b border-gray-100 flex relative">
                <button onclick="closeTopModal()" class="absolute top-2 right-2 z-[60] w-12 h-12 flex items-center justify-center text-red-600 hover:text-red-700 bg-transparent border-none outline-none cursor-pointer"><i class="fa-solid fa-xmark text-3xl"></i></button>
                <div class="w-24 h-24 rounded-lg overflow-hidden border border-gray-200 p-1 shrink-0 bg-white -mt-8 shadow-md">
                    <img id="v-img" src="" class="w-full h-full object-contain">
                </div>
                <div class="ml-4 flex flex-col justify-end pb-1 pr-12 overflow-hidden">
                    <div id="v-price" class="text-xl md:text-2xl font-black product-price-current leading-none mb-1 whitespace-nowrap overflow-hidden text-ellipsis tracking-tight">0‚Ç´</div>
                    <div class="text-sm text-gray-500 font-medium">Kho: <span id="v-stock" class="text-dark font-bold">0</span></div>
                </div>
            </div>
            <div class="p-5 overflow-y-auto custom-scrollbar flex-1">
                <div id="v-variants" class="space-y-4 mb-6"></div>
                <div class="flex items-center justify-between py-4 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-dark">S·ªë l∆∞·ª£ng</h4>
                    <div class="flex items-center border border-gray-200 rounded-lg p-1 bg-white shadow-sm">
                        <button onclick="adjQty(-1)" class="w-9 h-9 rounded text-gray-600 font-bold hover:bg-gray-100 transition bg-transparent border-none cursor-pointer"><i class="fa-solid fa-minus"></i></button>
                        <input id="pm-qty" type="text" inputmode="numeric" value="1" oninput="this.value = this.value.replace(/[^0-9]/g, '');" onblur="validatePmQty(true)" class="w-12 h-9 bg-transparent text-center text-lg font-bold text-dark focus:outline-none mx-1 border-none">
                        <button onclick="adjQty(1)" class="w-9 h-9 rounded text-gray-600 font-bold hover:bg-gray-100 transition bg-transparent border-none cursor-pointer"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <div class="p-4 pb-6 md:pb-4 border-t border-gray-100 bg-white shrink-0 relative z-[9999] md:rounded-b-[24px]">
                <button id="btn-confirm-variant" onclick="executeVariantAction()" class="w-full bg-primary hover:bg-primaryHover text-white font-bold py-2.5 rounded-lg shadow-md transition text-sm border-none cursor-pointer">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 z-[200] hidden bg-black/95 flex flex-col items-center justify-center backdrop-blur-sm">
        <button onclick="closeLightbox()" class="absolute top-2 right-2 md:top-4 md:right-4 w-14 h-14 flex items-center justify-center text-red-600 hover:text-red-700 z-[210] transition bg-transparent border-none outline-none drop-shadow-md cursor-pointer"><i class="fa-solid fa-xmark text-4xl"></i></button>
        <button onclick="prevLightbox()" class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 text-white/70 hover:text-white text-3xl z-[210] hidden md:block transition bg-transparent border-none outline-none drop-shadow-md cursor-pointer"><i class="fa-solid fa-chevron-left"></i></button>
        <button onclick="nextLightbox()" class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 text-white/70 hover:text-white text-3xl z-[210] hidden md:block transition bg-transparent border-none outline-none drop-shadow-md cursor-pointer"><i class="fa-solid fa-chevron-right"></i></button>
        <div class="w-full h-full overflow-hidden relative">
            <div id="lightbox-track" class="flex w-full h-full transition-transform duration-300" style="touch-action: pan-y;"></div>
        </div>
        <div id="lightbox-dots" class="absolute bottom-6 left-0 w-full flex justify-center gap-3 z-[210]"></div>
    </div>

    <div id="blog-modal" class="modal-wrapper">
        <div class="absolute inset-0" onclick="closeTopModal()"></div>
        <div class="modal-content bg-white w-full md:max-w-2xl h-full md:h-auto md:max-h-[85vh] rounded-t-3xl md:rounded-3xl relative z-10 flex flex-col overflow-hidden font-sans shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-100 bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm shrink-0">
                <span class="text-base font-extrabold text-primary uppercase tracking-widest flex items-center gap-2 leading-none"><i class="fa-solid fa-book-open"></i> G√≥c Kinh Nghi·ªám</span>
                <button onclick="closeTopModal()" class="w-12 h-12 flex items-center justify-end text-red-600 hover:text-red-700 bg-transparent border-none outline-none cursor-pointer"><i class="fa-solid fa-xmark text-3xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 bg-white custom-scrollbar" id="bm-body"></div>
        </div>
    </div>

    <div id="cart-modal" class="modal-wrapper">
        <div class="absolute inset-0" onclick="closeTopModal()"></div>
        <div class="modal-content bg-white w-full md:max-w-[450px] h-full md:h-[85vh] md:rounded-3xl relative z-10 flex flex-col overflow-hidden font-sans">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white shrink-0 relative">
                <h3 class="font-extrabold text-2xl text-dark flex items-center gap-3"><i class="fa-solid fa-cart-shopping text-primary"></i> Gi·ªè h√†ng</h3>
                <button onclick="closeTopModal()" class="absolute top-3 right-3 w-12 h-12 flex items-center justify-center text-red-600 hover:text-red-700 bg-transparent border-none outline-none cursor-pointer"><i class="fa-solid fa-xmark text-3xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-gray-50 space-y-4 custom-scrollbar" id="cart-items-list"></div>
            <div class="p-4 pb-6 md:pb-4 border-t border-gray-100 bg-white shadow-[0_-10px_30px_rgba(0,0,0,0.03)] shrink-0 relative z-[9999]">
                <div class="flex justify-between items-end mb-4 px-2">
                    <span class="text-gray-500 font-medium text-sm">T·ªïng thanh to√°n:</span>
                    <span id="cart-total" class="text-2xl font-black product-price-current">0‚Ç´</span>
                </div>
                <button onclick="goToPayment()" class="w-full bg-primary hover:bg-primaryHover text-white font-bold py-2.5 rounded-lg shadow-md transition transform hover:-translate-y-0.5 text-sm flex items-center justify-center gap-2 border-none cursor-pointer">Ti·∫øn h√†nh thanh to√°n <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="modal-wrapper">
        <div class="absolute inset-0" onclick="closeTopModal()"></div>
        <div class="modal-content bg-[#f8f9fa] md:rounded-3xl w-full h-full md:h-auto md:max-h-[92vh] max-w-[500px] relative z-10 overflow-hidden md:mx-4 flex flex-col font-sans shadow-2xl">
            <div class="p-5 bg-dark text-white flex justify-between items-center shrink-0 relative">
                <h3 class="font-extrabold text-xl flex items-center gap-3"><i class="fa-solid fa-shield-halved text-primary"></i> Thanh to√°n</h3>
                <button onclick="closeTopModal()" class="absolute top-2 right-2 w-12 h-12 flex items-center justify-center text-red-600 hover:text-red-700 bg-transparent border-none outline-none cursor-pointer"><i class="fa-solid fa-xmark text-3xl"></i></button>
            </div>
            <div class="p-5 overflow-y-auto space-y-5 flex-1 custom-scrollbar" id="pay-scroll-area">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="text-sm font-bold text-dark uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-bag-shopping text-primary"></i> ƒê∆°n h√†ng (<span id="pay-qty">0</span> sp)</h4>
                    <div id="pay-order-items" class="bg-gray-50 p-3 rounded-lg text-sm space-y-3 max-h-[180px] overflow-y-auto custom-scrollbar border border-gray-200"></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
                    <div class="mb-3 border-b border-gray-100 pb-2">
                        <h4 class="text-sm font-bold text-dark uppercase mb-1 flex items-center gap-2"><i class="fa-solid fa-location-dot text-primary"></i> Giao h√†ng</h4>
                        <p class="text-[10px] text-red-600 font-bold"><i class="fa-regular fa-lightbulb mr-1"></i> Vui l√≤ng ƒëi·ªÅn ch√≠nh x√°c th√¥ng tin.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                         <input type="tel" id="pay-phone" oninput="removeError(this)" class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 focus:ring-2 focus:ring-primary transition" placeholder="SƒêT... *">
                         <input type="text" id="pay-name" oninput="removeError(this)" class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 focus:ring-2 focus:ring-primary transition" placeholder="T√™n ng∆∞·ªùi nh·∫≠n... *">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="pay-prov" onchange="loadDistricts(); removeError(this)" class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 appearance-none focus:ring-2 focus:ring-primary transition"><option value="">T·ªânh/Th√†nh ph·ªë</option></select>
                        <select id="pay-dist" onchange="loadWards(); removeError(this)" disabled class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 appearance-none disabled:opacity-60 focus:ring-2 focus:ring-primary transition"><option value="">Qu·∫≠n/Huy·ªán</option></select>
                    </div>
                    <select id="pay-ward" onchange="removeError(this)" disabled class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 appearance-none disabled:opacity-60 focus:ring-2 focus:ring-primary transition"><option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option></select>
                    <input type="text" id="pay-addr" oninput="removeError(this)" class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 focus:ring-2 focus:ring-primary transition" placeholder="S·ªë nh√†, T√™n ƒë∆∞·ªùng *">
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
                     <h4 class="text-sm font-bold text-dark uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-wallet text-primary"></i> Thanh to√°n</h4>
                    <select id="pay-method" onchange="toggleQR(); removeError(this)" class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-bold text-sm text-dark bg-orange-50 appearance-none focus:ring-2 focus:ring-primary transition cursor-pointer">
                        <option value="">--- Ch·ªçn h√¨nh th·ª©c ---</option>
                        <option value="Cash On Delivery">üí≥ Nh·∫≠n h√†ng thanh to√°n (COD)</option>
                        <option value="Customer Banking">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                    </select>
                    <div id="qr-section" class="hidden text-center p-4 border border-dashed border-primary/50 rounded-xl bg-orange-50 transition-all duration-500 overflow-hidden mt-4">
                        <p class="text-sm font-bold text-primary mb-3">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                        <img id="qr-image" src="" class="w-full h-auto max-h-[300px] object-contain bg-white p-3 rounded-xl shadow-sm mb-4" loading="lazy">
                        <button onclick="downloadQR(event)" class="w-full bg-white border border-primary text-primary font-bold py-3 px-4 rounded-xl shadow-sm hover:bg-orange-100 transition border-none cursor-pointer flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download text-lg"></i> T·∫£i ·∫£nh QR v·ªÅ m√°y
                        </button>
                    </div>
                    <input type="text" id="pay-note" class="w-full border-0 ring-1 ring-gray-200 rounded-lg px-3 py-2.5 outline-none font-medium text-sm bg-gray-50 focus:ring-2 focus:ring-primary transition mt-3" placeholder="Ghi ch√∫ cho shop (kh√¥ng b·∫Øt bu·ªôc)...">
                </div>
            </div>
            <div class="p-4 pb-6 md:pb-4 bg-white border-t border-gray-100 shadow-[0_-10px_30px_rgba(0,0,0,0.03)] shrink-0 relative z-[9999]">
                <div class="space-y-1.5 mb-4 text-sm font-medium px-2">
                    <div class="flex justify-between text-gray-500"><span>T·∫°m t√≠nh:</span><span id="pay-subtotal" class="font-bold text-dark">0‚Ç´</span></div>
                    <div class="flex justify-between text-gray-500"><span>Ph√≠ v·∫≠n chuy·ªÉn:</span><span id="pay-shipping" class="font-bold text-dark">0‚Ç´</span></div>
                    <div class="border-t border-dashed border-gray-200 pt-2 mt-1 flex justify-between items-end"><span class="font-bold text-dark text-base">T·ªïng c·ªông:</span><span id="pay-total-final" class="text-xl font-black product-price-current">0‚Ç´</span></div>
                </div>
                <button onclick="confirmPayment()" id="btn-submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-lg shadow-md transition transform hover:-translate-y-0.5 text-sm flex items-center justify-center gap-2 border-none cursor-pointer">X√°c nh·∫≠n ƒë·∫∑t h√†ng
            </div>
        </div>
    </div>

    <div id="popup-announce" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-6 px-4 font-sans">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="document.getElementById('popup-announce').classList.add('hidden')"></div>
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full relative z-10 text-center transform transition-all scale-100">
            <div id="popup-icon-wrap" class="w-20 h-20 bg-gradient-to-tr from-orange-100 to-orange-200 rounded-2xl flex items-center justify-center mx-auto mb-6 text-primary text-4xl shadow-md rotate-3"><i class="fa-solid fa-bell"></i></div>
            <h3 id="popup-title" class="text-2xl font-extrabold text-dark mb-3 leading-tight uppercase"></h3>
            <p id="popup-msg" class="text-gray-600 mb-8 leading-relaxed font-medium"></p>
            <button onclick="document.getElementById('popup-announce').classList.add('hidden')" class="bg-primary text-white hover:bg-primaryHover font-bold py-2.5 px-10 rounded-xl w-full transition transform shadow-md text-sm border-none cursor-pointer">ƒê√£ hi·ªÉu</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-6 px-4 font-sans">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="document.getElementById('confirm-modal').classList.add('hidden')"></div>
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full relative z-10 text-center transform transition-all scale-100">
            <div class="w-20 h-20 bg-red-50 rounded-2xl flex items-center justify-center mx-auto mb-6 text-red-50 text-4xl shadow-md rotate-3"><i class="fa-solid fa-circle-exclamation"></i></div>
            <h3 id="confirm-title" class="text-2xl font-extrabold text-dark mb-3 leading-tight">X√°c nh·∫≠n</h3>
            <p id="confirm-msg" class="text-gray-600 mb-8 leading-relaxed font-medium"></p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="flex-1 bg-gray-100 text-gray-600 font-bold py-2.5 rounded-xl hover:bg-gray-200 transition text-sm border-none cursor-pointer">Kh√¥ng</button>
                <button id="confirm-btn-yes" class="flex-1 bg-red-600 text-white font-bold py-2.5 rounded-xl hover:bg-red-700 shadow-md transition transform text-sm border-none cursor-pointer">Ch·∫Øc ch·∫Øn</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw3yTDmPNyqA7awlynG8jnBDB1bf8ig44TCxdW22HHU_ZYqLLQnCvxkqly9m9iCs8EU/exec";
        let appData = { config: {}, products: [], blog: [], categories: [], banners: [] };
        let groupedProducts = {};
        let cart = {};
        try { let saved = localStorage.getItem('cart'); if (saved) { cart = JSON.parse(saved); if (typeof cart !== 'object' || Array.isArray(cart)) cart = {}; } } catch(e) { cart = {}; }
        
        let modalStack = [];
        let savedScrollY = 0;
        let currentView = 'shop';
        let hasTrackingResult = false;

        function switchView(v, push = true) {
            ['shop','blog','tracking'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            if(v==='blog') renderBlog();
            window.scrollTo({top:0, behavior:'smooth'});
            currentView = v;
            hasTrackingResult = false;
            if (v==='tracking') { document.getElementById('tracking-result-area').classList.add('hidden'); }
            if (push) history.pushState({ view: v, result: false }, '');
        }

        function openModal(id, isReplace = false) {
            const el = document.getElementById(id);
            if (!el) return;
            if (modalStack.length === 0) {
                savedScrollY = window.scrollY;
                document.body.style.position = 'fixed';
                document.body.style.top = `-${savedScrollY}px`;
                document.body.style.width = '100%';
                document.body.style.overflowY = 'scroll';
            }
            el.classList.add('open');
            if (isReplace && modalStack.length > 0) {
                const oldId = modalStack.pop();
                const oldEl = document.getElementById(oldId);
                if(oldEl) {
                    if(oldId === 'lightbox') oldEl.classList.add('hidden');
                    else oldEl.classList.remove('open');
                }
                modalStack.push(id);
                history.replaceState({ view: currentView, result: hasTrackingResult, modal: id }, '');
            } else {
                modalStack.push(id);
                history.pushState({ view: currentView, result: hasTrackingResult, modal: id }, '');
            }
        }

        window.addEventListener('popstate', function(e) {
            if (modalStack.length > 0) {
                const id = modalStack.pop();
                const el = document.getElementById(id);
                if(el) {
                    if(id === 'lightbox') el.classList.add('hidden');
                    else el.classList.remove('open');
                }
                if(id === 'product-modal') clearInterval(pmSlideInterval);
                if (modalStack.length === 0) {
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.width = '';
                    document.body.style.overflowY = '';
                    window.scrollTo(0, savedScrollY);
                }
                return;
            }
            if (e.state && e.state.view) {
                const v = e.state.view;
                currentView = v;
                hasTrackingResult = e.state.result || false;
                ['shop','blog','tracking'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
                document.getElementById('view-'+v).classList.remove('hidden');
                if (v === 'tracking') {
                    if (hasTrackingResult) {
                        document.getElementById('tracking-result-area').classList.remove('hidden');
                    } else {
                        document.getElementById('tracking-result-area').classList.add('hidden');
                        document.getElementById('track-phone-input').value = '';
                    }
                }
            }
        });

        function closeTopModal() { if (modalStack.length > 0) { history.back(); } }

        function forceCloseAllModals() {
            if (modalStack.length > 0) { history.go(-modalStack.length); }
            document.querySelectorAll('.modal-wrapper').forEach(m => m.classList.remove('open'));
            document.getElementById('lightbox').classList.add('hidden');
            clearInterval(pmSlideInterval);
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflowY = '';
            window.scrollTo(0, savedScrollY);
            modalStack = [];
        }

        let lbImages = []; let lbIndex = 0; let lbTouchStartX = 0; let lbTouchEndX = 0;

        function openLightbox(index) {
            lbIndex = index;
            const track = document.getElementById('lightbox-track');
            const dots = document.getElementById('lightbox-dots');
            track.innerHTML = ''; dots.innerHTML = '';
            lbImages.forEach((url, i) => {
                track.innerHTML += `<div class="w-full h-full flex-shrink-0 flex items-center justify-center p-2"><img src="${url}" class="max-w-full max-h-full object-contain cursor-default" loading="lazy"></div>`;
                dots.innerHTML += `<div class="w-2.5 h-2.5 rounded-full transition-all cursor-pointer ${i === lbIndex ? 'bg-primary scale-125' : 'bg-white/50 hover:bg-white'}" onclick="goToLightbox(${i})"></div>`;
            });
            updateLightboxSlider();
            document.getElementById('lightbox').classList.remove('hidden');
            modalStack.push('lightbox');
            history.pushState({ view: currentView, result: hasTrackingResult, modal: 'lightbox' }, '');
            track.ontouchstart = (e) => lbTouchStartX = e.touches[0].clientX;
            track.ontouchend = (e) => { lbTouchEndX = e.changedTouches[0].clientX; handleLbSwipe(); };
        }

        function closeLightbox() { if(modalStack[modalStack.length-1] === 'lightbox') { history.back(); } else { document.getElementById('lightbox').classList.add('hidden'); } }
        function updateLightboxSlider() {
            document.getElementById('lightbox-track').style.transform = `translateX(-${lbIndex * 100}%)`;
            const dots = document.getElementById('lightbox-dots').children;
            for(let i=0; i<dots.length; i++) { dots[i].className = `w-2.5 h-2.5 rounded-full transition-all cursor-pointer ${i === lbIndex ? 'bg-primary scale-125' : 'bg-white/50 hover:bg-white'}`; }
        }
        function nextLightbox() { if(lbImages.length <= 1) return; lbIndex = (lbIndex + 1) % lbImages.length; updateLightboxSlider(); }
        function prevLightbox() { if(lbImages.length <= 1) return; lbIndex = (lbIndex - 1 + lbImages.length) % lbImages.length; updateLightboxSlider(); }
        function goToLightbox(idx) { lbIndex = idx; updateLightboxSlider(); }
        function handleLbSwipe() { const diff = lbTouchStartX - lbTouchEndX; if (Math.abs(diff) > 50) { if (diff > 0) nextLightbox(); else prevLightbox(); } }

        let currentGroup = null; let a1Name="", a2Name=""; let a1List=[], a2List=[]; let selA1="", selA2=""; let finalVar = null;
        let pmCurrentIndex = 0; let pmSlideInterval; let touchStartX = 0; let touchEndX = 0;
        let currentBannerIndex = 0; let bannerInterval; let activeBanners = [];
        let currentPage = 1; const productsPerPage = 10; let currentFilteredProducts = [];
        let blogCurrentPage = 1; const blogPerPage = 10;
        let pendingAction = ''; let isDirectBuy = false;

        function formatMoney(num) { return (parseInt(num) || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '‚Ç´'; }
        function removeError(el) { el.classList.remove('input-error'); }
        function formatTimeVN(dateStr) {
            if(!dateStr) return 'Ch∆∞a r√µ'; let d = new Date(dateStr);
            if(!isNaN(d.getTime())) {
                let h = String(d.getHours()).padStart(2, '0'); let m = String(d.getMinutes()).padStart(2, '0');
                let day = String(d.getDate()).padStart(2, '0'); let mon = String(d.getMonth() + 1).padStart(2, '0');
                return `${h}:${m} ${day}/${mon}/${d.getFullYear()}`;
            } return dateStr;
        }

        window.onload = async function() {
            history.replaceState({ view: 'shop', result: false }, '');
            try {
                loadProvinces(); 
                const fetchUrl = API_URL + "?t=" + new Date().getTime(); 
                const res = await fetch(fetchUrl, { cache: 'no-store' }); 
                const data = await res.json();
                if(data.status === 'success') {
                    appData = data; groupProductsData(); applyConfig(); initMenuCategories(); renderProducts('all'); renderCartItems(); updateCartBadge();
                    document.getElementById('app-loading').remove();
                    let popupOn = String(appData.config.POPUP_ON || "").toUpperCase();
                    if(popupOn === "TRUE") { showCustomPopup(appData.config.POPUP_TITLE || "Th√¥ng b√°o", appData.config.POPUP_MSG || ""); }
                } else throw new Error(data.message || "L·ªói x·ª≠ l√Ω Server");
            } catch(e) { document.getElementById('app-loading').innerHTML = `<div class="text-red-500 font-bold text-center p-4">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng t·∫£i l·∫°i trang!</div>`; }
        };

        function showCustomPopup(title, msg, isError = false) {
            document.getElementById('popup-title').innerHTML = title; document.getElementById('popup-msg').innerHTML = msg;
            const iconWrap = document.getElementById('popup-icon-wrap');
            if (isError) { iconWrap.className = 'w-20 h-20 bg-gradient-to-tr from-red-100 to-red-200 rounded-2xl flex items-center justify-center mx-auto mb-6 text-red-500 text-4xl shadow-md rotate-3'; iconWrap.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>'; } 
            else { iconWrap.className = 'w-20 h-20 bg-gradient-to-tr from-orange-100 to-orange-200 rounded-2xl flex items-center justify-center mx-auto mb-6 text-primary text-4xl shadow-md rotate-3'; iconWrap.innerHTML = '<i class="fa-solid fa-bell"></i>'; }
            document.getElementById('popup-announce').classList.remove('hidden');
        }

        function groupProductsData() {
            groupedProducts = {};
            (appData.products||[]).forEach(p => {
                if(!groupedProducts[p.maSP]) groupedProducts[p.maSP] = { info: p, variants: [], min: Infinity, max: -Infinity, sold: 0 };
                const g = groupedProducts[p.maSP]; g.variants.push(p);
                let pr = parseInt(p.giaSKU) || 0; if(pr < g.min) g.min = pr; if(pr > g.max) g.max = pr;
                g.sold += (parseInt(p.DaBan_Ao)||0) + (parseInt(p.DaBan_That)||0);
            });
        }

        function applyConfig() {
            const c = appData.config || {};
            if(c.BRAND_COLOR) document.documentElement.style.setProperty('--brand-color', c.BRAND_COLOR);
            if(c.SLOGAN_COLOR) document.documentElement.style.setProperty('--slogan-color', c.SLOGAN_COLOR);
            if(c.GRADIENT_COLORS) document.documentElement.style.setProperty('--gradient-colors', c.GRADIENT_COLORS);
            if(c.SHOP_NAME) { document.title = c.SHOP_NAME; setText('footer-shop-name', c.SHOP_NAME); setText('header-shop-name', c.SHOP_NAME); }
            if(c.SLOGAN) { setText('footer-slogan', c.SLOGAN); }
            if(c.LOGO_URL) { const logo = document.getElementById('img-logo-display'); logo.src = c.LOGO_URL; logo.style.display = 'block'; document.getElementById('default-logo-wrap').style.display = 'none'; } 
            if(c.MARQUEE_TEXT) { document.getElementById('marquee-track').innerHTML = `<div class="marquee-item"><i class="fa-solid fa-bullhorn"></i> ${c.MARQUEE_TEXT}</div>`.repeat(10); document.getElementById('marquee-section').classList.remove('hidden'); }
            initBanner();
            setText('txt-hotline', c.HOTLINE || "ƒêang c·∫≠p nh·∫≠t"); setLink('btn-hotline', c.HOTLINE ? `tel:${c.HOTLINE}` : '#');
            setLink('btn-zalo', c.ZALO_CSKH || '#'); setLink('btn-group', c.GROUP_ZALO || '#');
            setText('menu-copy-text', c.COPYRIGHT || "¬© 2026 Shop. All rights reserved.");
            if(c.BANK_QR) document.getElementById('qr-image').src = c.BANK_QR;
        }

        function initBanner() {
            if (!appData.banners || appData.banners.length === 0) return;
            const s = document.getElementById('banner-slider'); const d = document.getElementById('banner-dots');
            s.innerHTML = ''; d.innerHTML = ''; activeBanners = appData.banners.slice(0, 5);
            activeBanners.forEach((url, i) => { s.innerHTML += `<div class="banner-slide"><img src="${url}" loading="lazy"></div>`; d.innerHTML += `<div class="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full transition-all ${i===0 ? 'bg-primary scale-125' : 'bg-gray-300 hover:bg-primary/50'} cursor-pointer" onclick="goToBanner(${i})"></div>`; });
            if (activeBanners.length > 1) startBannerAutoSlide();
        }
        function startBannerAutoSlide() { clearInterval(bannerInterval); bannerInterval = setInterval(() => { nextBanner(); }, 4000); }
        function goToBanner(idx) { currentBannerIndex = idx; updateBannerUI(); startBannerAutoSlide(); }
        function nextBanner() { currentBannerIndex = (currentBannerIndex + 1) % activeBanners.length; updateBannerUI(); startBannerAutoSlide(); }
        function prevBanner() { currentBannerIndex = (currentBannerIndex - 1 + activeBanners.length) % activeBanners.length; updateBannerUI(); startBannerAutoSlide(); }
        function updateBannerUI() {
            document.getElementById('banner-slider').style.transform = `translateX(-${currentBannerIndex * 100}%)`;
            const dots = document.getElementById('banner-dots').children;
            for(let i=0; i<dots.length; i++) dots[i].className = `w-2 h-2 md:w-2.5 md:h-2.5 rounded-full transition-all ${i===currentBannerIndex ? 'bg-primary scale-125' : 'bg-gray-300 hover:bg-primary/50'} cursor-pointer`;
        }

        function initMenuCategories() {
            const div = document.getElementById('menu-categories'); div.innerHTML = '';
            (appData.categories||[]).forEach(c => {
                const a = document.createElement('a'); a.href = "#"; a.className = "flex items-center p-3 rounded-xl font-medium text-gray-700 hover:bg-orange-50 hover:text-primary transition group";
                a.innerHTML = `<span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-3 group-hover:bg-orange-200 transition"><i class="fa-solid ${c.Icon || 'fa-folder'} text-gray-500 group-hover:text-primary"></i></span> ${c.Ten}`;
                a.onclick = (e) => { e.preventDefault(); filterByCategory(c.ID); }; div.appendChild(a);
            });
        }

        function renderProducts(catId, search = '') {
            currentFilteredProducts = [];
            Object.values(groupedProducts).forEach(g => {
                const p = g.info; 
                if(catId !== 'all' && p.danhMuc !== catId) return; 
                if(search && !p.tenSP.toLowerCase().includes(search.toLowerCase())) return;
                currentFilteredProducts.push(g);
            });
            let titleText = ''; const banner = document.getElementById('main-banner');
            if (catId === 'all' && search === '') {
                titleText = 'Trang ch·ªß'; if(banner) banner.style.display = 'block'; document.getElementById('filter-section').style.display = 'none';
            } else {
                let foundCat = appData.categories.find(c=>c.ID===catId);
                if(search) titleText = `K·∫øt qu·∫£ cho: "${search}"`; else titleText = foundCat ? foundCat.Ten : 'Danh m·ª•c';
                if(banner) banner.style.display = 'none'; document.getElementById('filter-section').style.display = 'block';
            }
            setText('category-title', titleText);
            currentPage = 1; document.getElementById('products-grid').innerHTML = ''; 
            if(currentFilteredProducts.length === 0) { 
                document.getElementById('products-grid').innerHTML = `<div class="col-span-full text-center text-gray-500 py-10 italic">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</div>`;
                document.getElementById('pagination-container').innerHTML = ''; return; 
            }
            displayProductsPage();
        }

        function displayProductsPage() {
            const grid = document.getElementById('products-grid');
            const start = (currentPage - 1) * productsPerPage; const end = start + productsPerPage;
            const itemsToShow = currentFilteredProducts.slice(start, end);
            grid.classList.remove('animate-fade-up'); void grid.offsetWidth; grid.classList.add('animate-fade-up');
            grid.innerHTML = ''; 
            itemsToShow.forEach(g => {
                const p = g.info; 
                let priceStr = formatMoney(g.min); if(g.min !== g.max) priceStr += ' - ' + formatMoney(g.max);
                let badgeColor = (p.trangThai && p.trangThai.toLowerCase() === 's·∫Øp v·ªÅ h√†ng') ? 'background-color: var(--main-color);' : 'background-color: #dc2626;';
                let badgeHtml = p.trangThai ? `<span class="product-badge" style="${badgeColor}">${p.trangThai}</span>` : '';
                let totalStock = g.variants.reduce((sum, v) => sum + (parseInt(v.TonKho_HienThi)||0), 0);
                let outOfStockHtml = totalStock <= 0 ? `<div class="text-[10px] font-extrabold text-red-600 border border-red-500 px-2 py-0.5 rounded uppercase tracking-wide bg-transparent w-fit mx-auto mt-1.5">H·∫æT H√ÄNG</div>` : ``;
                const div = document.createElement('div'); div.className = 'card-gradient-border'; div.onclick = () => openProductDetail(p.maSP);
                div.innerHTML = `
                    <div class="card-inner group">
                        <div class="product-image-wrapper"><img src="${p.anhDaiDien}" class="product-image" loading="lazy">${badgeHtml}</div>
                        <div class="p-3 md:p-4 flex flex-col flex-grow">
                            <h3 class="product-title group-hover:text-primary transition text-left line-clamp-2">${p.tenSP}</h3>
                            <div class="product-footer mt-auto flex flex-col items-center justify-center w-full overflow-hidden">
                                <div class="product-price-section w-full px-1">
                                    <span class="product-price-current block w-full text-center whitespace-nowrap overflow-hidden text-ellipsis text-[13px] md:text-base tracking-tighter">${priceStr}</span>
                                </div>
                                <div class="product-sold text-[10px] md:text-[11px] text-gray-500 flex items-center justify-center gap-1 mt-1 font-medium whitespace-nowrap"><i class="fa-solid fa-fire-flame-simple text-orange-400"></i> ƒê√£ b√°n ${g.sold}</div>
                                ${outOfStockHtml}
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(div);
            });
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(currentFilteredProducts.length / productsPerPage);
            const container = document.getElementById('pagination-container');
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            let html = '<div class="flex flex-wrap justify-center gap-2">';
            if (currentPage > 1) { html += `<button onclick="goToPage(${currentPage - 1})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-600 hover:bg-orange-50 hover:text-primary transition shadow-sm border-none"><i class="fa-solid fa-chevron-left"></i></button>`; }
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) { html += `<button class="w-10 h-10 flex items-center justify-center rounded-xl bg-primary text-white font-bold shadow-md transform scale-105 border-none">${i}</button>`;
                } else { html += `<button onclick="goToPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-600 font-medium hover:bg-orange-50 hover:text-primary transition shadow-sm border-none">${i}</button>`; }
            }
            if (currentPage < totalPages) { html += `<button onclick="goToPage(${currentPage + 1})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-600 hover:bg-orange-50 hover:text-primary transition shadow-sm border-none"><i class="fa-solid fa-chevron-right"></i></button>`; }
            html += '</div>'; container.innerHTML = html;
        }

        function goToPage(page) { currentPage = page; displayProductsPage(); const filterSec = document.getElementById('filter-section'); if (filterSec && filterSec.style.display !== 'none') { window.scrollTo({top: filterSec.offsetTop - 80, behavior: 'smooth'}); } else { window.scrollTo({top: document.getElementById('products-grid').offsetTop - 100, behavior: 'smooth'}); } }

        function openProductDetail(maSP) {
            currentGroup = groupedProducts[maSP]; const info = currentGroup.info;
            pmCurrentIndex = 0; clearInterval(pmSlideInterval);
            const track = document.getElementById('pm-slider-track'); 
            const dots = document.getElementById('pm-dots');
            const thumbs = document.getElementById('pm-thumbnails');
            track.innerHTML = ''; dots.innerHTML = ''; thumbs.innerHTML = ''; 
            track.style.transform = `translateX(0%)`;
            const imgs = [info.anhDaiDien, info.anh1, info.anh2, info.anh3, info.anh4].filter(Boolean);
            lbImages = imgs;
            imgs.forEach((url, i) => {
                track.innerHTML += `<div class="pm-slide w-full h-full flex-shrink-0 flex items-center justify-center p-2 bg-white"><img src="${url}" onclick="openLightbox(${i})" class="max-w-full max-h-full object-contain cursor-zoom-in hover:opacity-90 transition" loading="lazy"></div>`;
                const dot = document.createElement('div'); 
                dot.className = `w-2.5 h-2.5 rounded-full transition-all ${i===0 ? 'bg-primary scale-125' : 'bg-gray-300 hover:bg-primary/50'} cursor-pointer`;
                dot.onclick = () => goToPmSlide(i); 
                dots.appendChild(dot);
                const thumb = document.createElement('div');
                thumb.className = `w-14 h-14 rounded-lg border-2 overflow-hidden cursor-pointer transition-all flex-shrink-0 bg-white ${i===0 ? 'border-primary opacity-100 shadow-sm' : 'border-transparent opacity-50 hover:opacity-100'}`;
                thumb.innerHTML = `<img src="${url}" class="w-full h-full object-contain p-1">`;
                thumb.onclick = () => goToPmSlide(i);
                thumbs.appendChild(thumb);
            });
            if(imgs.length > 1) { startPmAutoSlide(); track.ontouchstart = (e) => touchStartX = e.touches[0].clientX; track.ontouchend = (e) => { touchEndX = e.changedTouches[0].clientX; handlePmSwipe(); }; }
            setText('pm-title', info.tenSP); setText('pm-sold', currentGroup.sold);
            document.getElementById('pm-desc').innerHTML = String(info.moTa || "").replace(/\n/g, '<br>');
            let badgeColor = (info.trangThai && info.trangThai.toLowerCase() === 's·∫Øp v·ªÅ h√†ng') ? 'background-color: var(--main-color);' : 'background-color: #dc2626;';
            const badge = document.getElementById('pm-badge'); if(info.trangThai) { badge.textContent = info.trangThai; badge.setAttribute('style', badgeColor); badge.classList.remove('hidden'); } else badge.classList.add('hidden');
            const ghichu = document.getElementById('pm-ghichu'); if(info.ghiChu) { ghichu.textContent = info.ghiChu; ghichu.classList.remove('hidden'); } else ghichu.classList.add('hidden');
            let priceStr = formatMoney(currentGroup.min); if(currentGroup.min !== currentGroup.max) priceStr += ' - ' + formatMoney(currentGroup.max);
            setText('pm-price', priceStr);
            let vars = currentGroup.variants; 
            a1Name = vars[0].thuocTinh1 || ""; a2Name = vars[0].thuocTinh2 || "";
            a1List = [...new Set(vars.map(v=>v.giaTri1).filter(Boolean))]; 
            a2List = [...new Set(vars.map(v=>v.giaTri2).filter(Boolean))];
            selA1 = ""; selA2 = ""; finalVar = null; document.getElementById('pm-qty').value = 1;
            openModal('product-modal');
        }

        function startPmAutoSlide() { const c = document.querySelectorAll('.pm-slide').length; if (c <= 1) return; clearInterval(pmSlideInterval); pmSlideInterval = setInterval(() => { nextPmSlide(); }, 4000); }
        function nextPmSlide() { const c = document.querySelectorAll('.pm-slide').length; if (c <= 1) return; pmCurrentIndex = (pmCurrentIndex + 1) % c; updatePmSlider(); startPmAutoSlide(); }
        function prevPmSlide() { const c = document.querySelectorAll('.pm-slide').length; if (c <= 1) return; pmCurrentIndex = (pmCurrentIndex - 1 + c) % c; updatePmSlider(); startPmAutoSlide(); }
        function goToPmSlide(idx) { pmCurrentIndex = idx; updatePmSlider(); startPmAutoSlide(); }
        
        function updatePmSlider() { 
            document.getElementById('pm-slider-track').style.transform = `translateX(-${pmCurrentIndex * 100}%)`; 
            const dots = document.getElementById('pm-dots').children; 
            for(let i=0; i<dots.length; i++) { dots[i].className = `w-2.5 h-2.5 rounded-full transition-all ${i===pmCurrentIndex ? 'bg-primary scale-125' : 'bg-gray-300 hover:bg-primary/50'} cursor-pointer`; }
            const thumbs = document.getElementById('pm-thumbnails').children;
            for(let i=0; i<thumbs.length; i++) { thumbs[i].className = `w-14 h-14 rounded-lg border-2 overflow-hidden cursor-pointer transition-all flex-shrink-0 bg-white ${i===pmCurrentIndex ? 'border-primary opacity-100 shadow-sm scale-105' : 'border-transparent opacity-50 hover:opacity-100'}`; }
        }
        function handlePmSwipe() { const diff = touchStartX - touchEndX; if (Math.abs(diff) > 50) { if (diff > 0) nextPmSlide(); else prevPmSlide(); } }

        function triggerVariantSheet(actionType) {
            try {
                pendingAction = actionType;
                let totalStock = 0;
                if(currentGroup && currentGroup.variants) { totalStock = currentGroup.variants.reduce((sum, v) => sum + (parseInt(v.TonKho_HienThi ? v.TonKho_HienThi : 0)), 0); }
                if(totalStock <= 0) { showToast('S·∫£n ph·∫©m n√†y ƒë√£ h·∫øt h√†ng!'); return; }
                let imgEl = document.getElementById('v-img');
                if(imgEl && currentGroup && currentGroup.info) imgEl.src = currentGroup.info.anhDaiDien || '';
                buildVariantUI();
                openModal('variant-sheet');
            } catch(e) { showToast("L·ªói d·ªØ li·ªáu, vui l√≤ng th·ª≠ l·∫°i!"); }
        }

        function buildVariantUI() {
            let html = "";
            if(a1List.length > 0) { 
                html += `<div class="mb-4"><p class="text-sm font-bold text-dark mb-2">${a1Name}</p><div class="flex flex-wrap gap-2">`; 
                a1List.forEach(v => { 
                    let stockForV = currentGroup.variants.filter(item => (item.giaTri1||"") === v && (selA2 === "" || (item.giaTri2||"") === selA2)).reduce((sum, item) => sum + (parseInt(item.TonKho_HienThi ? item.TonKho_HienThi : 0)), 0);
                    if (stockForV <= 0) { html += `<button class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-bold bg-gray-50 text-gray-400 opacity-50 cursor-not-allowed">${v}</button>`; } 
                    else { let act = (v === selA1) ? "border-primary bg-orange-50 text-primary ring-1 ring-primary shadow-sm" : "border-gray-200 text-gray-600 bg-white"; html += `<button onclick="selA1='${v}'; updateVarLogic()" class="px-4 py-2 border rounded-lg text-sm font-bold transition ${act} cursor-pointer">${v}</button>`; }
                }); html += `</div></div>`; 
            }
            if(a2List.length > 0) { 
                html += `<div class="mb-4"><p class="text-sm font-bold text-dark mb-2">${a2Name}</p><div class="flex flex-wrap gap-2">`; 
                a2List.forEach(v => { 
                    let stockForV = currentGroup.variants.filter(item => (item.giaTri2||"") === v && (selA1 === "" || (item.giaTri1||"") === selA1)).reduce((sum, item) => sum + (parseInt(item.TonKho_HienThi ? item.TonKho_HienThi : 0)), 0);
                    if (stockForV <= 0) { html += `<button class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-bold bg-gray-50 text-gray-400 opacity-50 cursor-not-allowed">${v}</button>`; } 
                    else { let act = (v === selA2) ? "border-primary bg-orange-50 text-primary ring-1 ring-primary shadow-sm" : "border-gray-200 text-gray-600 bg-white"; html += `<button onclick="selA2='${v}'; updateVarLogic()" class="px-4 py-2 border rounded-lg text-sm font-bold transition ${act} cursor-pointer">${v}</button>`; }
                }); html += `</div></div>`; 
            }
            document.getElementById('v-variants').innerHTML = html; updateVarLogic(true);
        }

        function updateVarLogic(skipBuild = false) {
            if(!skipBuild) buildVariantUI(); 
            let isFullySelected = (a1List.length === 0 || selA1 !== "") && (a2List.length === 0 || selA2 !== "");
            const stockDisplay = document.getElementById('v-stock');
            if (isFullySelected) {
                finalVar = currentGroup.variants.find(v => (v.giaTri1||"")===selA1 && (v.giaTri2||"")===selA2) || currentGroup.variants[0];
                setText('v-price', formatMoney(finalVar.giaSKU)); 
                let stock = parseInt(finalVar.TonKho_HienThi)||0; stockDisplay.textContent = stock;
            } else {
                finalVar = null; let priceStr = formatMoney(currentGroup.min); if(currentGroup.min !== currentGroup.max) priceStr += ' - ' + formatMoney(currentGroup.max);
                setText('v-price', priceStr);
                let totalStock = currentGroup.variants.reduce((sum, v) => sum + (parseInt(v.TonKho_HienThi ? v.TonKho_HienThi : 0)), 0);
                stockDisplay.textContent = totalStock;
            }
            validatePmQty(true);
        }

        function validatePmQty(forceMin = false) { 
            let el = document.getElementById('pm-qty'); 
            let v = parseInt(el.value); 
            let max = 0; 
            if (finalVar) { max = parseInt(finalVar.TonKho_HienThi) || 0; } 
            else if (currentGroup) { max = currentGroup.variants.reduce((sum, val) => sum + (parseInt(val.TonKho_HienThi ? val.TonKho_HienThi : 0)), 0); }
            
            if (isNaN(v) || v < 1) { 
                if(forceMin) { v = 1; el.value = 1; }
            } else {
                if (max > 0 && v > max) { el.value = max; } 
                else if (max === 0 && forceMin) { el.value = 1; }
            }
        }
        
        function adjQty(d) { 
            let el = document.getElementById('pm-qty'); 
            let v = parseInt(el.value) || 0;
            v += d; 
            if(v < 1) v = 1; 
            let max = 0; 
            if (finalVar) { max = parseInt(finalVar.TonKho_HienThi) || 0; } 
            else if (currentGroup) { max = currentGroup.variants.reduce((sum, val) => sum + (parseInt(val.TonKho_HienThi ? val.TonKho_HienThi : 0)), 0); }
            if (max > 0 && v > max) v = max; 
            else if (max === 0) v = 1; 
            el.value = v; 
            validatePmQty(true);
        }

        function executeVariantAction() {
            let isFullySelected = (a1List.length === 0 || selA1 !== "") && (a2List.length === 0 || selA2 !== "");
            if (!isFullySelected) { showToast('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ph√¢n lo·∫°i!'); return; }
            if (!finalVar || parseInt(finalVar.TonKho_HienThi) <= 0) { showToast('Ph√¢n lo·∫°i n√†y ƒë√£ h·∫øt h√†ng!'); return; }
            
            let qtyVal = parseInt(document.getElementById('pm-qty').value);
            if (isNaN(qtyVal) || qtyVal <= 0) {
                showToast('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng l·ªõn h∆°n 0!');
                document.getElementById('pm-qty').value = 1; 
                return;
            }

            if (pendingAction === 'cart') { actionAddCart(); }
            else if (pendingAction === 'buy') { actionBuyNow(); }
        }

        function actionAddCart() { 
            addToCart(parseInt(document.getElementById('pm-qty').value)); 
            closeTopModal(); 
            showToast('ƒê√£ th√™m v√†o gi·ªè h√†ng!'); 
        }
        
        function actionBuyNow() { 
            isDirectBuy = true; 
            let newOrderObj = Object.assign({}, finalVar, {
                qty: parseInt(document.getElementById('pm-qty').value), sku: finalVar.maBienThe, name: finalVar.tenSP, detail: [finalVar.giaTri1, finalVar.giaTri2].filter(Boolean).join(' - '), price: finalVar.giaSKU, img: finalVar.anhDaiDien || currentGroup.info.anhDaiDien 
            });
            openModal('payment-modal', true); 
            const list = document.getElementById('pay-order-items'); list.innerHTML = ''; let total = 0, count = 0;
            [newOrderObj].forEach(i => { total += i.price * i.qty; count += i.qty; list.innerHTML += `<div class="flex flex-col border-b border-dashed border-gray-200 pb-2 mb-2 last:border-0 last:pb-0 last:mb-0"><div class="text-xs font-bold text-dark">${i.name}</div><div class="text-[11px] text-gray-500 mb-1">Ph√¢n lo·∫°i: ${i.detail || 'M·∫∑c ƒë·ªãnh'}</div><div class="flex justify-between items-center mt-1"><div class="text-xs text-gray-600">SL: <span class="font-bold text-dark">${i.qty}</span> <span class="mx-1">x</span> <span class="text-primary font-bold">${formatMoney(i.price)}</span></div><div class="text-sm font-black text-primary">${formatMoney(i.price * i.qty)}</div></div></div>`; });
            const ship = parseInt(appData.config.SHIP_FEE || 30000); setText('pay-qty', count); setText('pay-subtotal', formatMoney(total)); setText('pay-shipping', formatMoney(ship)); setText('pay-total-final', formatMoney(total+ship)); window.currentOrderItems = [newOrderObj];
        }

        function renderBlog() { blogCurrentPage = 1; displayBlogPage(); }
        function displayBlogPage() {
            const grid = document.getElementById('blog-grid'); grid.innerHTML = '';
            const start = (blogCurrentPage - 1) * blogPerPage; const end = start + blogPerPage;
            const itemsToShow = (appData.blog || []).slice(start, end);
            itemsToShow.forEach((b, i) => {
                let realIdx = start + i; const div = document.createElement('div'); div.className = 'card-gradient-border'; div.onclick = () => openBlogDetail(realIdx);
                div.innerHTML = `<div class="card-inner group"><div class="relative aspect-[4/3] overflow-hidden border-b border-gray-100"><img src="${b.anhBia}" class="w-full h-full object-cover transition transform group-hover:scale-105 duration-500" loading="lazy"></div><div class="p-4 flex flex-col flex-1"><h3 class="font-bold text-sm text-dark leading-tight line-clamp-2">${b.tieuDe}</h3><p class="text-[10px] text-gray-400 mt-2 font-bold"><i class="fa-regular fa-calendar-days mr-1"></i> ${b.ngayDang}</p></div></div>`;
                grid.appendChild(div);
            }); renderBlogPagination();
        }
        function renderBlogPagination() {
            const totalPages = Math.ceil((appData.blog || []).length / blogPerPage); const container = document.getElementById('blog-pagination-container');
            if (totalPages <= 1) { container.innerHTML = ''; return; } let html = '<div class="flex flex-wrap justify-center gap-2">';
            if (blogCurrentPage > 1) { html += `<button onclick="goToBlogPage(${blogCurrentPage - 1})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-600 hover:bg-orange-50 hover:text-primary transition shadow-sm border-none"><i class="fa-solid fa-chevron-left"></i></button>`; }
            for (let i = 1; i <= totalPages; i++) {
                if (i === blogCurrentPage) { html += `<button class="w-10 h-10 flex items-center justify-center rounded-xl bg-primary text-white font-bold shadow-md transform scale-105 border-none">${i}</button>`; } 
                else { html += `<button onclick="goToBlogPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-600 font-medium hover:bg-orange-50 hover:text-primary transition shadow-sm border-none">${i}</button>`; }
            }
            if (blogCurrentPage < totalPages) { html += `<button onclick="goToBlogPage(${blogCurrentPage + 1})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-600 hover:bg-orange-50 hover:text-primary transition shadow-sm border-none"><i class="fa-solid fa-chevron-right"></i></button>`; }
            html += '</div>'; container.innerHTML = html;
        }
        function goToBlogPage(page) { blogCurrentPage = page; displayBlogPage(); window.scrollTo({top: document.getElementById('view-blog').offsetTop - 80, behavior: 'smooth'}); }

        function openBlogDetail(idx) {
            let b = appData.blog[idx]; if(!b) return;
            let html = `<div class="relative h-72 md:h-96"><img src="${b.anhBia}" class="w-full h-full object-cover" loading="lazy"><div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div><div class="absolute bottom-0 left-0 p-6 md:p-8 w-full"><h2 class="text-3xl md:text-4xl font-black text-white mb-3 leading-tight drop-shadow-lg">${b.tieuDe}</h2><p class="text-sm text-white/90 font-medium flex items-center gap-2"><i class="fa-regular fa-clock"></i> Ng√†y ƒëƒÉng: ${b.ngayDang}</p></div></div><div class="p-6 md:p-10 text-dark leading-relaxed space-y-8 text-justify bg-white">`;
            for(let i=1; i<=10; i++) { if(b[`noiDung${i}`]) html += `<p class="text-base md:text-lg text-gray-700">${String(b[`noiDung${i}`]).replace(/\n/g, '<br>')}</p>`; if(b[`anhMinhHoa${i}`]) html += `<div class="rounded-2xl overflow-hidden shadow-sm my-6"><img src="${b[`anhMinhHoa${i}`]}" class="w-full object-cover" loading="lazy"></div>`; }
            html += `</div><div class="h-10 bg-white"></div>`; document.getElementById('bm-body').innerHTML = html; openModal('blog-modal');
        }

        function addToCart(qty) {
            let sku = finalVar.maBienThe; if(!cart[sku]) { cart[sku] = { sku: sku, qty: 0, name: finalVar.tenSP, detail: [finalVar.giaTri1, finalVar.giaTri2].filter(Boolean).join(' - '), price: finalVar.giaSKU, img: finalVar.anhDaiDien || currentGroup.info.anhDaiDien }; }
            cart[sku].qty += qty; saveCart(); updateCartBadge();
        }
        function saveCart() { localStorage.setItem('cart', JSON.stringify(cart)); }
        function updateCartBadge() { let count = Object.values(cart).reduce((a,b)=>a+b.qty,0); let b = document.getElementById('cart-count'); b.querySelector('span').textContent = count > 99 ? '99+' : count; if(count>0) b.classList.add('show'); else b.classList.remove('show'); }

        function renderCartItems() {
            const list = document.getElementById('cart-items-list'); list.innerHTML = ''; let total = 0; const items = Object.values(cart);
            if (items.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 py-10 flex flex-col items-center"><i class="fa-solid fa-cart-shopping text-6xl mb-4 text-gray-200"></i><p>Gi·ªè h√†ng tr·ªëng</p></div>`; } 
            else { items.forEach(i => { total += i.price * i.qty; const div = document.createElement('div'); div.className = 'flex gap-4 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 relative'; div.innerHTML = `<div class="w-20 h-20 rounded-xl overflow-hidden shrink-0 border border-gray-100 p-1 bg-gray-50"><img src="${i.img}" class="w-full h-full object-contain" loading="lazy"></div><div class="flex-1 min-w-0 flex flex-col"><div class="font-bold text-dark truncate pr-6 mb-1 text-sm">${i.name}</div><div class="text-[11px] font-medium text-gray-500 mb-2 bg-gray-100 px-2 py-0.5 rounded-md w-fit">${i.detail || 'M·∫∑c ƒë·ªãnh'}</div><div class="mt-auto flex justify-between items-center"><div class="text-primary font-extrabold product-price-current">${formatMoney(i.price)}</div><div class="flex items-center border border-gray-200 rounded-lg p-0.5 bg-gray-50"><button onclick="cartMod('${i.sku}', -1)" class="w-6 h-6 rounded bg-white shadow-sm hover:bg-gray-100 text-xs transition border-none"><i class="fa-solid fa-minus"></i></button><input type="text" inputmode="numeric" value="${i.qty}" oninput="this.value = this.value.replace(/[^0-9]/g, ''); cartSetQty('${i.sku}', this.value)" class="w-8 h-6 bg-transparent text-center text-sm font-bold focus:outline-none border-none"><button onclick="cartMod('${i.sku}', 1)" class="w-6 h-6 rounded bg-white shadow-sm hover:bg-gray-100 text-xs transition border-none"><i class="fa-solid fa-plus"></i></button></div></div></div><button class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 text-sm transition border-none cursor-pointer" onclick="cartMod('${i.sku}', 0)"><i class="fa-solid fa-trash-can"></i></button>`; list.appendChild(div); }); }
            setText('cart-total', formatMoney(total));
        }

        function cartSetQty(sku, val) { let v = parseInt(val); if (isNaN(v) || v < 1) v = 1; cart[sku].qty = v; saveCart(); updateCartBadge(); renderCartItems(); }
        function cartMod(sku, delta) { if(delta===0 || cart[sku].qty+delta<=0) delete cart[sku]; else cart[sku].qty += delta; saveCart(); updateCartBadge(); renderCartItems(); }
        
        function goToPayment() { 
            if(Object.keys(cart).length === 0) return; 
            isDirectBuy = false; 
            openModal('payment-modal', true); 
            const list = document.getElementById('pay-order-items'); list.innerHTML = ''; let total = 0, count = 0;
            Object.values(cart).forEach(i => { total += i.price * i.qty; count += i.qty; list.innerHTML += `<div class="flex flex-col border-b border-dashed border-gray-200 pb-2 mb-2 last:border-0 last:pb-0 last:mb-0"><div class="text-xs font-bold text-dark">${i.name}</div><div class="text-[11px] text-gray-500 mb-1">Ph√¢n lo·∫°i: ${i.detail || 'M·∫∑c ƒë·ªãnh'}</div><div class="flex justify-between items-center mt-1"><div class="text-xs text-gray-600">SL: <span class="font-bold text-dark">${i.qty}</span> <span class="mx-1">x</span> <span class="text-primary font-bold">${formatMoney(i.price)}</span></div><div class="text-sm font-black text-primary">${formatMoney(i.price * i.qty)}</div></div></div>`; });
            const ship = parseInt(appData.config.SHIP_FEE || 30000); setText('pay-qty', count); setText('pay-subtotal', formatMoney(total)); setText('pay-shipping', formatMoney(ship)); setText('pay-total-final', formatMoney(total+ship)); window.currentOrderItems = Object.values(cart); 
        }

        async function loadProvinces() { try { let res = await fetch('https://provinces.open-api.vn/api/p/'); let data = await res.json(); let html = '<option value="">T·ªânh/Th√†nh ph·ªë</option>'; data.forEach(p => html += `<option value="${p.code}">${p.name}</option>`); document.getElementById('pay-prov').innerHTML = html; } catch(e) {} }
        async function loadDistricts() { let pCode = document.getElementById('pay-prov').value; let dSelect = document.getElementById('pay-dist'); let wSelect = document.getElementById('pay-ward'); if(!pCode) { dSelect.disabled=true; wSelect.disabled=true; dSelect.innerHTML='<option value="">Qu·∫≠n/Huy·ªán</option>'; wSelect.innerHTML='<option value="">Ph∆∞·ªùng/X√£</option>'; return; } try { let res = await fetch(`https://provinces.open-api.vn/api/p/${pCode}?depth=2`); let data = await res.json(); let html = '<option value="">Qu·∫≠n/Huy·ªán</option>'; data.districts.forEach(d => html += `<option value="${d.code}">${d.name}</option>`); dSelect.innerHTML = html; dSelect.disabled = false; wSelect.disabled = true; wSelect.innerHTML='<option value="">Ph∆∞·ªùng/X√£</option>'; } catch(e) {} }
        async function loadWards() { let dCode = document.getElementById('pay-dist').value; let wSelect = document.getElementById('pay-ward'); if(!dCode) { wSelect.disabled=true; wSelect.innerHTML='<option value="">Ph∆∞·ªùng/X√£</option>'; return; } try { let res = await fetch(`https://provinces.open-api.vn/api/d/${dCode}?depth=2`); let data = await res.json(); let html = '<option value="">Ph∆∞·ªùng/X√£</option>'; data.wards.forEach(w => html += `<option value="${w.code}">${w.name}</option>`); wSelect.innerHTML = html; wSelect.disabled = false; } catch(e) {} }

        async function confirmPayment() {
            let phoneEl = document.getElementById('pay-phone'); let nameEl = document.getElementById('pay-name'); let provEl = document.getElementById('pay-prov'); let distEl = document.getElementById('pay-dist'); let wardEl = document.getElementById('pay-ward'); let addrEl = document.getElementById('pay-addr'); let methodEl = document.getElementById('pay-method');
            let phoneVal = phoneEl.value.trim(); const phoneRegex = /^0\d{9}$/; 
            let fields = [ { el: phoneEl, isValid: phoneRegex.test(phoneVal) }, { el: nameEl, isValid: nameEl.value.trim() !== "" }, { el: provEl, isValid: provEl.value !== "" }, { el: distEl, isValid: distEl.value !== "" }, { el: wardEl, isValid: wardEl.value !== "" }, { el: addrEl, isValid: addrEl.value.trim() !== "" }, { el: methodEl, isValid: methodEl.value !== "" } ];
            let hasError = false; let firstErrorEl = null;
            fields.forEach(f => { if (!f.isValid) { f.el.classList.add('input-error'); if (!hasError) { hasError = true; firstErrorEl = f.el; } } else { removeError(f.el); } });
            if (hasError && firstErrorEl) { firstErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstErrorEl.focus(); return; }
            let prov = provEl.options[provEl.selectedIndex].text; let dist = distEl.options[distEl.selectedIndex].text; let ward = wardEl.options[wardEl.selectedIndex].text;
            let fullAddress = `${addrEl.value.trim()}, ${ward}, ${dist}, ${prov}`; 
            let btn = document.getElementById('btn-submit'); const origText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> ƒêang x·ª≠ l√Ω...'; btn.disabled = true;
            let totalRawNumber = window.currentOrderItems.reduce((a,b)=>a+b.price*b.qty,0) + parseInt(appData.config.SHIP_FEE || 30000); 
            
            let payload = { action: 'placeOrder', hoTen: nameEl.value.trim(), sdt: phoneVal, diaChi: fullAddress, hinhThuc: methodEl.value, ghiChu: val('pay-note'), tongTien: totalRawNumber, items: window.currentOrderItems };
            try {
                const res = await fetch(API_URL, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify(payload) }); const json = await res.json();
                if(json.status === 'success') { 
                    forceCloseAllModals(); 
                    setTimeout(() => {
                        showCustomPopup('ƒê·∫∂T H√ÄNG TH√ÄNH C√îNG!', `M√£ ƒë∆°n h√†ng: <b class="text-orange-600 text-lg">${json.maDon}</b><br>C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng Shop!<br><span class="block mt-4 text-xs text-red-600 font-bold"><i class="fa-regular fa-lightbulb mr-1"></i> B·∫°n c√≥ th·ªÉ tra c·ª©u h√†nh tr√¨nh ho·∫∑c h·ªßy ƒë∆°n ·ªü m·ª•c Menu.</span>`); 
                        if(!isDirectBuy) { cart = {}; saveCart(); updateCartBadge(); renderCartItems(); } 
                    }, 100);
                } else throw new Error(json.message);
            } catch(e) { showCustomPopup('L·ªói ƒë·∫∑t h√†ng', e.message, true); } finally { btn.innerHTML = origText; btn.disabled = false; }
        }

        async function performTracking() {
            const pEl = document.getElementById('track-phone-input'); const p = pEl.value.trim(); const phoneRegex = /^0\d{9}$/; 
            if(!phoneRegex.test(p)) { pEl.classList.add('input-error'); pEl.focus(); return; } else { removeError(pEl); }
            const resArea = document.getElementById('tracking-result-area'); const listArea = document.getElementById('tracking-list');
            resArea.classList.remove('hidden'); listArea.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary mb-3"></i><p class="text-gray-500 font-medium">ƒêang t√¨m ki·∫øm ƒë∆°n h√†ng c·ªßa b·∫°n...</p></div>';
            hasTrackingResult = true; history.pushState({ view: 'tracking', result: true }, '');

            try {
                const payload = { action: 'trackOrder', sdt: p };
                const res = await fetch(API_URL, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify(payload) }); const data = await res.json();
                if(data.status === 'success' && data.orders && data.orders.length > 0) {
                    listArea.innerHTML = '';
                    data.orders.forEach(o => {
                        let status = String(o.trangThai || 'M·ªõi').trim(); let isNew = (status.toLowerCase() === 'm·ªõi' || status.toLowerCase() === 'moi' || status === '');
                        let stColor = isNew ? 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50' : status.toLowerCase().includes('h·ªßy') ? 'bg-red-100 text-red-600 border border-transparent' : 'bg-green-100 text-green-600 border border-transparent';
                        let statusHTML = isNew ? `<div class="cancel-menu-container relative inline-block text-left" id="status-container-${o.maDon}"><button onclick="toggleCancelMenu('menu-${o.maDon}')" class="text-xs px-3 py-1.5 rounded-lg font-bold uppercase tracking-wider ${stColor} flex items-center gap-1 transition shadow-sm border-none cursor-pointer">M·ªöI <i class="fa-solid fa-chevron-down text-[10px]"></i></button><div id="menu-${o.maDon}" class="cancel-menu-dropdown hidden absolute right-0 mt-2 w-44 bg-white border border-red-100 rounded-xl shadow-xl z-20 overflow-hidden"><button onclick="confirmCancelOrder('${o.maDon}')" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 font-bold transition flex items-center gap-2 border-none cursor-pointer"><i class="fa-solid fa-xmark"></i> H·ªßy ƒë∆°n h√†ng</button></div></div>` : `<div id="status-container-${o.maDon}"><span class="text-xs px-3 py-1.5 rounded-lg font-bold uppercase tracking-wider ${stColor} shadow-sm">${status}</span></div>`;
                        let trackingHTML = ''; let maVanDonHTML = '';
                        if (o.maVanDon) { maVanDonHTML = `<span class="inline-flex items-center text-[10px] font-bold bg-orange-50 text-primary px-2 py-0.5 rounded border border-orange-100 ml-2 shadow-sm">M√£ Vƒê: ${o.maVanDon}</span>`; }
                        if (o.linkVanChuyen && o.maVanDon) { let fullLink = String(o.linkVanChuyen).trim() + String(o.maVanDon).trim(); trackingHTML = `<a href="${fullLink}" target="_blank" class="mt-4 w-full py-3 bg-orange-50 text-primary border border-orange-100 hover:bg-orange-100 font-bold rounded-xl transition flex justify-center items-center gap-2 shadow-sm"><i class="fa-solid fa-truck-fast"></i> Theo d√µi h√†nh tr√¨nh</a>`; }
                        listArea.innerHTML += `<div class="bg-white border border-gray-200 rounded-2xl p-4 md:p-5 shadow-sm text-left relative mb-4"><div class="mb-3 border-b border-gray-100 pb-3"><div class="font-black text-base md:text-lg text-dark flex items-center flex-wrap mb-1">#${o.maDon} ${maVanDonHTML}</div><div class="flex justify-between items-center mt-1"><div class="text-xs text-gray-400 font-medium"><i class="fa-regular fa-clock"></i> ${formatTimeVN(o.ngayDat)}</div>${statusHTML}</div></div><div class="text-sm space-y-2 mb-4"><div class="flex"><span class="w-20 md:w-24 text-gray-500 font-medium">Ng∆∞·ªùi nh·∫≠n:</span> <span class="font-bold text-dark flex-1">${o.hoTen || '-'}</span></div><div class="flex"><span class="w-20 md:w-24 text-gray-500 font-medium">SƒêT:</span> <span class="font-medium text-dark flex-1">${p}</span></div><div class="flex"><span class="w-20 md:w-24 text-gray-500 font-medium">ƒê·ªãa ch·ªâ:</span> <span class="font-medium text-dark flex-1 leading-snug">${o.diaChi || '-'}</span></div><div class="flex pt-2"><span class="w-20 md:w-24 text-gray-500 font-medium">T·ªïng ti·ªÅn:</span> <span class="font-black text-primary text-base flex-1">${formatMoney(o.tongTien)}</span></div></div><div class="bg-gray-50 p-3 md:p-4 rounded-xl text-xs md:text-sm text-gray-600 leading-relaxed border border-gray-100"><div class="font-bold text-dark mb-2 flex items-center gap-2"><i class="fa-solid fa-box-open text-primary"></i> Chi ti·∫øt s·∫£n ph·∫©m</div>${o.chiTiet ? String(o.chiTiet).replace(/\n/g, '<br>') : 'ƒêang c·∫≠p nh·∫≠t...'}</div>${trackingHTML}</div>`;
                    });
                } else { listArea.innerHTML = `<div class="text-center py-8 bg-gray-50 rounded-2xl border border-gray-100"><i class="fa-solid fa-box-open text-5xl text-gray-300 mb-4"></i><p class="text-gray-500 font-medium">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o kh·ªõp v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y.</p></div>`; }
            } catch(e) { listArea.innerHTML = `<div class="text-center py-6 bg-red-50 text-red-500 font-medium rounded-2xl"><i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i><br>Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i!</div>`; }
        }

        function toggleCancelMenu(id) { const menu = document.getElementById(id); document.querySelectorAll('.cancel-menu-dropdown').forEach(m => { if(m.id !== id) m.classList.add('hidden'); }); menu.classList.toggle('hidden'); }
        function confirmCancelOrder(maDon) { document.querySelectorAll('.cancel-menu-dropdown').forEach(m => m.classList.add('hidden')); document.getElementById('confirm-title').innerText = 'H·ªßy ƒë∆°n h√†ng?'; document.getElementById('confirm-msg').innerHTML = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng <b>${maDon}</b> kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`; document.getElementById('confirm-modal').classList.remove('hidden'); document.getElementById('confirm-btn-yes').onclick = function() { document.getElementById('confirm-modal').classList.add('hidden'); executeCancelOrder(maDon); }; }
        async function executeCancelOrder(maDon) { showToast('ƒêang g·ª≠i y√™u c·∫ßu h·ªßy ƒë∆°n...'); try { const payload = { action: 'cancelOrder', maDon: maDon }; const res = await fetch(API_URL, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify(payload) }); const data = await res.json(); if(data.status === 'success') { const statusWrap = document.getElementById('status-container-' + maDon); if(statusWrap) { statusWrap.className = ''; statusWrap.innerHTML = `<span class="text-xs px-3 py-1.5 rounded-lg font-bold uppercase tracking-wider bg-red-100 text-red-600 border border-transparent shadow-sm">H·ªßy ƒë∆°n</span>`; } showCustomPopup('H·ªßy ƒë∆°n th√†nh c√¥ng!', `ƒê∆°n h√†ng <b>${maDon}</b> ƒë√£ ƒë∆∞·ª£c h·ªßy.`); } else { showCustomPopup('Kh√¥ng th·ªÉ h·ªßy', data.message || 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω', true); } } catch(e) { showCustomPopup('L·ªói k·∫øt n·ªëi', 'Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i!', true); } }
        
        // H√†m m·ªü QR v·ªõi hi·ªáu ·ª©ng tr∆∞·ª£t l√™n m∆∞·ª£t m√†
        function toggleQR() { 
            const sec = document.getElementById('qr-section'); 
            if(val('pay-method') === 'Customer Banking') { 
                sec.classList.remove('hidden'); 
                sec.classList.add('animate-fade-up'); // Th√™m hi·ªáu ·ª©ng tr∆∞·ª£t l√™n
                setTimeout(() => { sec.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 150); 
            } else { 
                sec.classList.add('hidden'); 
                sec.classList.remove('animate-fade-up'); // G·ª° hi·ªáu ·ª©ng ƒë·ªÉ reset cho l·∫ßn sau
            } 
        }

        async function downloadQR(e) { e.preventDefault(); const qrSrc = document.getElementById('qr-image').src; if(!qrSrc) return; try { const response = await fetch(qrSrc); const blob = await response.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'QR_ThanhToan.png'; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); a.remove(); } catch(error) { window.open(qrSrc, '_blank'); } }
        
        function val(id) { return document.getElementById(id).value; } function setText(id, t) { let el=document.getElementById(id); if(el) el.innerText = t; } function setLink(id, l) { let el=document.getElementById(id); if(el) el.href = l; } 
        function handleSearch(q) { switchView('shop'); renderProducts('all', q); closeMenu(); }
        function filterByCategory(c) { switchView('shop'); renderProducts(c); closeMenu(); }
        function resetAndHome() { switchView('shop'); renderProducts('all'); closeMenu(); }
        function openMenu() { document.getElementById('mobile-menu').classList.add('open'); const ov = document.getElementById('overlay'); ov.classList.remove('opacity-0', 'pointer-events-none'); ov.classList.add('opacity-100', 'pointer-events-auto'); document.body.style.overflow = 'hidden'; }
        function closeMenu() { document.getElementById('mobile-menu').classList.remove('open'); const ov = document.getElementById('overlay'); ov.classList.remove('opacity-100', 'pointer-events-auto'); ov.classList.add('opacity-0', 'pointer-events-none'); document.body.style.overflow = ''; }
        function toggleCSKHMenu() { const m=document.getElementById('cskh-menu'); const a=document.getElementById('cskh-arrow'); if(m.classList.contains('hidden')){m.classList.remove('hidden');a.style.transform='rotate(180deg)';}else{m.classList.add('hidden');a.style.transform='rotate(0deg)';} }
        function showToast(msg) { const t = document.createElement('div'); t.className = 'toast-1-line'; t.innerHTML = `<i class="fa-solid fa-circle-check text-green-400"></i> ${msg}`; document.body.appendChild(t); setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 2000); }
    </script>
</body>
</html>